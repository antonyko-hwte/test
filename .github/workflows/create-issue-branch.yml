name: Create Issue Branch and PR

on:
  issues:
    types: [opened, assigned, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

# 권한 설정
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

env:
  ISSUE_NUMBER: ${{ github.event.issue.number }}
  ISSUE_TITLE: ${{ github.event.issue.title }}

jobs:
  create_prefixed_branch:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: 레이블 정보를 텍스트 파일로 저장
      - name: Extract and save label information
        id: extract_labels
        run: |
          # 레이블 정보를 JSON 파일로 저장
          echo '${{ toJSON(github.event.issue.labels) }}' > labels.json
          
          # 레이블 이름만 추출
          echo '${{ join(github.event.issue.labels.*.name, " ") }}' > label_names.txt
          
          # 디버그 출력
          echo "=== LABEL DEBUG INFO ==="
          echo "Raw JSON:"
          cat labels.json
          echo -e "\nLabel names:"
          cat label_names.txt
          
          # 레이블 존재 여부 체크
          if [ -s label_names.txt ] && [ "$(cat label_names.txt)" != "" ]; then
            echo "HAS_LABELS=true" >> $GITHUB_OUTPUT
          else
            echo "HAS_LABELS=false" >> $GITHUB_OUTPUT
          fi
      
      # Step 2: Python으로 정확한 레이블 파싱
      - name: Determine prefix using Python
        id: determine_prefix
        run: |
          cat << 'EOF' > parse_labels.py
          import json
          import sys
          
          # labels.json 파일 읽기
          with open('labels.json', 'r') as f:
              labels_data = f.read()
          
          try:
              labels = json.loads(labels_data)
              print(f"DEBUG: Number of labels: {len(labels)}")
              
              # 각 레이블 확인
              for label in labels:
                  name = label['name'].lower()
                  print(f"DEBUG: Found label: '{name}'")
                  
                  if name == 'bug':
                      print('bugfix/')
                      sys.exit(0)
                  elif name == 'feature':
                      print('feature/')
                      sys.exit(0)
                  elif name == 'hotfix':
                      print('hotfix/')
                      sys.exit(0)
                  elif name == 'refactor':
                      print('refactor/')
                      sys.exit(0)
                  elif name == 'enhancement':
                      print('enhancement/')
                      sys.exit(0)
              
              # 매칭되는 레이블이 없으면 빈 문자열
              print('')
              
          except Exception as e:
              print(f"ERROR parsing labels: {e}")
              print('')
          EOF
          
          # Python 스크립트 실행
          PREFIX=$(python3 parse_labels.py)
          echo "DEBUG: Determined prefix: '${PREFIX}'"
          
          # GITHUB_OUTPUT에 저장
          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          
          # 브랜치 이름 생성
          BRANCH_NAME="${PREFIX}chistock-#${{ env.ISSUE_NUMBER }}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
      
      # Step 3: 생성될 브랜치 정보 출력
      - name: Display branch info
        run: |
          echo "=== BRANCH CREATION INFO ==="
          echo "Issue Number: ${{ env.ISSUE_NUMBER }}"
          echo "Issue Title: ${{ env.ISSUE_TITLE }}"
          echo "Prefix: '${{ steps.determine_prefix.outputs.prefix }}'"
          echo "Branch Name: '${{ steps.determine_prefix.outputs.branch_name }}'"
          echo "============================"
      
      # Step 4: GitHub API로 직접 브랜치 생성 (create-issue-branch 액션 사용 안함)
      - name: Create branch via GitHub API
        id: create_branch
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = ${{ env.ISSUE_NUMBER }};
            const branchName = '${{ steps.determine_prefix.outputs.branch_name }}';
            const prefix = '${{ steps.determine_prefix.outputs.prefix }}';
            
            console.log(`Creating branch: ${branchName}`);
            console.log(`With prefix: ${prefix}`);
            
            try {
              // 1. 기본 브랜치의 최신 커밋 SHA 가져오기
              const baseRef = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/main'  // 또는 'master', 'develop' 등
              });
              
              const baseSha = baseRef.data.object.sha;
              console.log(`Base SHA: ${baseSha}`);
              
              // 2. 새 브랜치 생성
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: baseSha
              });
              
              console.log(`✅ Branch created successfully: ${branchName}`);
              
              return {
                success: true,
                branchName: branchName,
                prefix: prefix
              };
              
            } catch (error) {
              console.error('❌ Failed to create branch:', error);
              throw error;
            }
