name: Create Issue Branch and PR

on:
  issues:
    types: [opened, assigned, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  create_issue_branch_job:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && (
        github.event.action == 'opened' ||
        github.event.action == 'assigned' ||
        github.event.action == 'labeled'
      ) &&
      !contains(github.event.issue.labels.*.name, 'docs') &&
      !contains(github.event.issue.labels.*.name, 'release') &&
      !contains(github.event.issue.labels.*.name, 'sub_issue') &&
      !contains(github.event.issue.labels.*.name, 'duplicate') &&
      !contains(github.event.issue.labels.*.name, 'invalid') &&
      !contains(github.event.issue.labels.*.name, 'question') &&
      !contains(github.event.issue.labels.*.name, 'wontfix') &&
      !contains(github.event.issue.labels.*.name, 'env')

    steps:
      - name: Determine branch name
        id: branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          # ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„: chistock-#{number}
          BASE_NAME="chistock-#${ISSUE_NUMBER}"
          
          # ë ˆì´ë¸”ì— ë”°ë¼ prefix ì¶”ê°€
          LABELS='${{ toJSON(github.event.issue.labels) }}'
          
          if echo "${LABELS}" | grep -q '"name":"bug"'; then
            BRANCH_NAME="bugfix/${BASE_NAME}"
          elif echo "${LABELS}" | grep -q '"name":"feature"'; then
            BRANCH_NAME="feature/${BASE_NAME}"
          elif echo "${LABELS}" | grep -q '"name":"hotfix"'; then
            BRANCH_NAME="hotfix/${BASE_NAME}"
          elif echo "${LABELS}" | grep -q '"name":"refactor"'; then
            BRANCH_NAME="refactor/${BASE_NAME}"
          else
            BRANCH_NAME="${BASE_NAME}"
          fi
          
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "base=${BASE_NAME}" >> $GITHUB_OUTPUT
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create and push branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
          git checkout -b "${{ steps.branch.outputs.name }}"
          git push -u origin "${{ steps.branch.outputs.name }}"
      
      - name: Create Pull Request
        id: create_pr
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const branchName = '${{ steps.branch.outputs.name }}';
            
            // PR ìƒì„±
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chistock-#${issue.number}: ${issue.title}`,
              head: branchName,
              base: 'main',
              body: `## ğŸ“Œ ê´€ë ¨ ì´ìŠˆ\nResolves #${issue.number}\n\n## ğŸ“ ì„¤ëª…\n${issue.body || 'ì´ìŠˆ í•´ê²°ì„ ìœ„í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.'}\n\n---\n*ìë™ ìƒì„±ëœ PRì…ë‹ˆë‹¤.*`,
              draft: true
            });
            
            // ë¼ë²¨ ë³µì‚¬
            if (issue.labels && issue.labels.length > 0) {
              const labels = issue.labels.map(label => label.name);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: labels
              });
            }
            
            // Assignee ë³µì‚¬
            if (issue.assignees && issue.assignees.length > 0) {
              const assignees = issue.assignees.map(assignee => assignee.login);
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                assignees: assignees
              });
            }
            
            return pr.data.number;
      
      - name: Update issue with branch info
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const branchName = '${{ steps.branch.outputs.name }}';
            const prNumber = '${{ steps.create_pr.outputs.result }}';
            
            // ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ‰ **ë¸Œëœì¹˜ ë° PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**\n\n` +
                    `**ë¸Œëœì¹˜**: \`${branchName}\`\n` +
                    `**PR**: #${prNumber}\n\n` +
                    `í•´ë‹¹ ë¸Œëœì¹˜ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.`
            });
