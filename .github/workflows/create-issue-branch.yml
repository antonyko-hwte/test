name: Create Issue Branch and PR

on:
  issues:
    types: [opened, assigned, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]

# 권한 설정
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  create_issue_branch_job:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && (
        github.event.action == 'opened' ||
        github.event.action == 'assigned' ||
        github.event.action == 'labeled'
      ) &&
      !contains(github.event.issue.labels.*.name, 'docs') &&
      !contains(github.event.issue.labels.*.name, 'release') &&
      !contains(github.event.issue.labels.*.name, 'sub_issue') &&
      !contains(github.event.issue.labels.*.name, 'duplicate') &&
      !contains(github.event.issue.labels.*.name, 'invalid') &&
      !contains(github.event.issue.labels.*.name, 'question') &&
      !contains(github.event.issue.labels.*.name, 'wontfix') &&
      !contains(github.event.issue.labels.*.name, 'env')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Issue Branch
        uses: robvanderleek/create-issue-branch@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config: |
            branches:
              - label: bug
                name: "bugfix/chistock-#${{ github.event.issue.number }}"
              - label: feature
                name: "feature/chistock-#${{ github.event.issue.number }}"
              - label: refactor
                name: "refactor/chistock-#${{ github.event.issue.number }}"
              - label: test
                name: "test/chistock-#${{ github.event.issue.number }}"
              - label: issue
                name: "issuefix/chistock-#${{ github.event.issue.number }}"
              - label: docs
                skip: true
              - label: release
                skip: true
              - label: duplicate
                skip: true
              - label: invalid
                skip: true
              - label: wontfix
                skip: true
              - label: env
                skip: true
              - label: question
                skip: true

            # 기능 설정
            autoLinkIssue: true
            autoCloseIssue: false
            openDraftPR: true
            copyIssueLabelsToPR: true
            copyIssueAssigneeToPR: true
            copyIssueBodyToPR: false  # 기본 템플릿 사용
            copyIssueProjectsToPR: true
            copyIssueMilestoneToPR: true
            # PR 설정 개선
            draftPRTitle: "[chistock-#${{ github.event.issue.number }}] ${{ github.event.issue.title }}"
            draftPRBody: |
              ## 관련 이슈
              Resolves #${{ github.event.issue.number }}
              ## 변경 사항
              이슈 #${{ github.event.issue.number }}를 해결하기 위한 PR입니다.
              ## 작업 내용
              - [ ] 작업 내용을 입력해주세요
              
              ## 테스트
              - [ ] 테스트를 완료했습니다
            # 기본 브랜치 설정
            defaultBranch: "main"
            # 기타 설정
            silent: false
            skipBranchForExistingPR: true
            commentOnIssue: true
            # 브랜치 이름 포맷 설정 추가
            branchNameFormat: "lowercase"
            replaceInvalidCharacters: true
          
      # 추가 단계: 생성 완료 후 알림
      - name: Notify on success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const branch = process.env.CREATED_BRANCH_NAME;
            
            if (branch) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `브랜치 및 PR이 생성되었습니다!\n\n**브랜치**: \`${branch}\`\n**이슈**: #${issue.number}\n\n작업을 시작해주세요!`
              });
            }

  # PR 머지 때 이슈 자동 닫기
  close_issue_on_pr_merge:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    
    permissions:
      issues: write
    
    steps:
      - name: Close related issue
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // PR 본문에서 이슈 번호 추출 (Resolves #123, Closes #123, Fixes #123 등)
            const issueMatch = body.match(/(?:Resolves|Closes|Fixes|Fix)\s+#(\d+)/i);
            
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `PR #${pr.number}이(가) 머지되어 이슈를 닫습니다.`
              });
            }
