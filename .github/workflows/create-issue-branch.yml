name: Create Issue Branch and PR

on:
  issues:
    types: [opened, assigned, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed, reopened]
  pull_request_target:
    types: [closed, reopened]

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write

jobs:
  create_issue_branch_job:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && (
        github.event.action == 'opened' ||
        github.event.action == 'assigned' ||
        github.event.action == 'labeled'
      ) &&
      !contains(github.event.issue.labels.*.name, 'docs') &&
      !contains(github.event.issue.labels.*.name, 'release') &&
      !contains(github.event.issue.labels.*.name, 'sub_issue') &&
      !contains(github.event.issue.labels.*.name, 'duplicate') &&
      !contains(github.event.issue.labels.*.name, 'invalid') &&
      !contains(github.event.issue.labels.*.name, 'question') &&
      !contains(github.event.issue.labels.*.name, 'wontfix') &&
      !contains(github.event.issue.labels.*.name, 'env')

    steps:
      - name: Determine prefix from labels
        id: get_prefix
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          
          # GitHub Actions ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë ˆì´ë¸” ì´ë¦„ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
          # labels ë°°ì—´ì—ì„œ ì´ë¦„ë§Œ ì¶”ì¶œ
          LABEL_NAMES=""
          PREFIX=""
          
          # ë””ë²„ê·¸: ëª¨ë“  ë ˆì´ë¸” ì •ë³´ ì¶œë ¥
          echo "DEBUG: All labels JSON:"
          echo '${{ toJSON(github.event.issue.labels) }}'
          
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ ë ˆì´ë¸” ì´ë¦„ë§Œ ì¶”ì¶œ (jqê°€ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •)
          # GitHub Actions Ubuntu runnerì—ëŠ” jqê°€ ê¸°ë³¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤
          LABEL_NAMES=$(echo '${{ toJSON(github.event.issue.labels) }}' | jq -r '.[].name' 2>/dev/null || echo "")
          
          echo "DEBUG: Extracted label names: $LABEL_NAMES"
          
          # ê° ë ˆì´ë¸”ì„ ê°œë³„ì ìœ¼ë¡œ í™•ì¸
          while IFS= read -r label; do
            if [ -n "$label" ]; then
              echo "DEBUG: Checking label: '$label'"
              
              # ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
              label_lower=$(echo "$label" | tr '[:upper:]' '[:lower:]')
              
              case "$label_lower" in
                *bug*)
                  if [ -z "$PREFIX" ]; then
                    PREFIX="bugfix/"
                    echo "DEBUG: Found 'bug' label, setting prefix to 'bugfix/'"
                  fi
                  ;;
                *feature*)
                  if [ -z "$PREFIX" ]; then
                    PREFIX="feature/"
                    echo "DEBUG: Found 'feature' label, setting prefix to 'feature/'"
                  fi
                  ;;
                *hotfix*)
                  if [ -z "$PREFIX" ]; then
                    PREFIX="hotfix/"
                    echo "DEBUG: Found 'hotfix' label, setting prefix to 'hotfix/'"
                  fi
                  ;;
                *refactor*)
                  if [ -z "$PREFIX" ]; then
                    PREFIX="refactor/"
                    echo "DEBUG: Found 'refactor' label, setting prefix to 'refactor/'"
                  fi
                  ;;
                *enhancement*)
                  if [ -z "$PREFIX" ]; then
                    PREFIX="enhancement/"
                    echo "DEBUG: Found 'enhancement' label, setting prefix to 'enhancement/'"
                  fi
                  ;;
              esac
            fi
          done <<< "$LABEL_NAMES"
          
          # ì „ì²´ ë¸Œëœì¹˜ ì´ë¦„ ìƒì„±
          BRANCH_NAME="${PREFIX}chistock-#${ISSUE_NUMBER}"
          
          echo "DEBUG: Final prefix: '$PREFIX'"
          echo "DEBUG: Final branch name: '$BRANCH_NAME'"
          
          echo "prefix=${PREFIX}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
      
      - name: Debug output
        run: |
          echo "Determined prefix: '${{ steps.get_prefix.outputs.prefix }}'"
          echo "Branch name will be: '${{ steps.get_prefix.outputs.branch_name }}'"
          echo "Issue number: ${{ steps.get_prefix.outputs.issue_number }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create and push branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          BRANCH_NAME="${{ steps.get_prefix.outputs.branch_name }}"
          
          echo "Creating branch: ${BRANCH_NAME}"
          
          # ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
          git checkout -b "${BRANCH_NAME}"
          # ë¹ˆ ì»¤ë°‹ ìƒì„±
          git commit --allow-empty -m "chore: Initialize branch for chistock-#${{ steps.get_prefix.outputs.issue_number }}"
          git push -u origin "${BRANCH_NAME}"

      - name: Create Pull Request
        id: create_pr
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const branchName = '${{ steps.get_prefix.outputs.branch_name }}';
            const prefix = '${{ steps.get_prefix.outputs.prefix }}'.replace('/', '');
            
            // PR ì œëª©ì— prefix í‘œì‹œ
            let prTitle = `chistock-#${issue.number}: ${issue.title}`;
            if (prefix) {
              prTitle = `[${prefix.toUpperCase()}] ${prTitle}`;
            }
            
            console.log(`Creating PR for branch: ${branchName}`);
            console.log(`PR title: ${prTitle}`);
            
            // PR ìƒì„±
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: branchName,
              base: 'main',
              body: `## ğŸ“Œ ê´€ë ¨ ì´ìŠˆ\nResolves #${issue.number}\n\n## ğŸ“ ì„¤ëª…\n${issue.body || 'ì´ìŠˆ í•´ê²°ì„ ìœ„í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.'}\n\n---\n*ìë™ ìƒì„±ëœ PRì…ë‹ˆë‹¤.*\n*ë¸Œëœì¹˜: \`${branchName}\`*`,
              draft: true
            });
            
            // ë¼ë²¨ ë³µì‚¬
            if (issue.labels && issue.labels.length > 0) {
              const labels = issue.labels.map(label => label.name);
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: labels
              });
            }
            
            // Assignee ë³µì‚¬
            if (issue.assignees && issue.assignees.length > 0) {
              const assignees = issue.assignees.map(assignee => assignee.login);
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                assignees: assignees
              });
            }
            
            return pr.data.number;

  # PRì´ ë‹«í ë•Œ ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸
  update_issue_on_pr_close:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          echo "PR Body: $PR_BODY"
          
          # PR ë³¸ë¬¸ì—ì„œ "Resolves #ì´ìŠˆë²ˆí˜¸" íŒ¨í„´ ì°¾ê¸°
          if [[ "$PR_BODY" =~ Resolves\ *#([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Found issue number: $ISSUE_NUMBER"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            # ë˜ëŠ” ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            echo "Branch name: $BRANCH_NAME"
            if [[ "$BRANCH_NAME" =~ chistock-#([0-9]+) ]]; then
              ISSUE_NUMBER="${BASH_REMATCH[1]}"
              echo "Found issue number from branch name: $ISSUE_NUMBER"
              echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "No issue reference found"
              echo "issue_number=" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Update issue status to DONE
        if: steps.extract_issue.outputs.issue_number != ''
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = ${{ steps.extract_issue.outputs.issue_number }};
            const prNumber = ${{ github.event.pull_request.number }};
            
            console.log(`Updating issue #${issueNumber} status to DONE (linked to PR #${prNumber})`);
            
            try {
              // ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€ (PRì´ mergeë˜ì—ˆìŒì„ ì•Œë¦¼)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âœ… **ì´ìŠˆ í•´ê²°ë¨**\nì—°ê²°ëœ PR #${prNumber}ì´(ê°€) mergeë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ DONE ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.`
              });
              
              // GitHub Projectsë¥¼ ì‚¬ìš©í•œë‹¤ë©´, ì´ìŠˆì— "DONE" ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['DONE']
              });
              
              // ì´ìŠˆë¥¼ closed ìƒíƒœë¡œ ë³€ê²½
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              
              console.log(`Successfully updated issue #${issueNumber} to DONE`);
              
            } catch (error) {
              console.error(`Error updating issue #${issueNumber}:`, error);
              // ì—ëŸ¬ ë°œìƒì‹œ PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **ìë™ ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨**\nì´ìŠˆ #${issueNumber}ë¥¼ DONE ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.\n\nì—ëŸ¬: ${error.message}`
              });
            }

  # PRì´ ì¬ì—´ë ¸ì„ ë•Œ ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸
  update_issue_on_pr_reopen:
    runs-on: ubuntu-latest
    # ì£¼ì˜: github.event.pull_request.merged == true ì¡°ê±´ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'reopened'
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Debug event context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Event action: ${{ github.event.action }}"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "PR title: ${{ github.event.pull_request.title }}"
          echo "PR head ref: ${{ github.event.pull_request.head.ref }}"
          echo "PR body preview: ${{ github.event.pull_request.body }}"
      
      - name: Extract issue number from PR
        id: extract_issue_reopen
        run: |
          # ë°©ë²• 1: PR ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ
          PR_BODY="${{ github.event.pull_request.body }}"
          echo "PR Body preview: ${PR_BODY:0:200}..."
          
          ISSUE_NUMBER=""
          
          # PR ë³¸ë¬¸ì—ì„œ "Resolves #ì´ìŠˆë²ˆí˜¸" íŒ¨í„´ ì°¾ê¸°
          if [[ -n "$PR_BODY" && "$PR_BODY" =~ [Rr]esolves\ *#([0-9]+) ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Found issue number from PR body (Resolves): $ISSUE_NUMBER"
          # PR ë³¸ë¬¸ì—ì„œ "#ì´ìŠˆë²ˆí˜¸" íŒ¨í„´ ì°¾ê¸°
          elif [[ -n "$PR_BODY" && "$PR_BODY" =~ \#([0-9]+) ]]; then
            # ì—¬ëŸ¬ ê°œê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì²« ë²ˆì§¸ ë§¤ì¹­ ì‚¬ìš©
            ISSUE_NUMBER="${BASH_REMATCH[1]}"
            echo "Found issue number from PR body (#): $ISSUE_NUMBER"
          fi
          
          # ë°©ë²• 2: ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì¶”ì¶œ
          if [[ -z "$ISSUE_NUMBER" ]]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            echo "Branch name: $BRANCH_NAME"
            if [[ "$BRANCH_NAME" =~ chistock-#([0-9]+) ]]; then
              ISSUE_NUMBER="${BASH_REMATCH[1]}"
              echo "Found issue number from branch name: $ISSUE_NUMBER"
            elif [[ "$BRANCH_NAME" =~ -#([0-9]+) ]]; then
              ISSUE_NUMBER="${BASH_REMATCH[1]}"
              echo "Found issue number from branch name pattern: $ISSUE_NUMBER"
            fi
          fi
          
          # ë°©ë²• 3: PR ì œëª©ì—ì„œ ì¶”ì¶œ
          if [[ -z "$ISSUE_NUMBER" ]]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "PR title: $PR_TITLE"
            if [[ "$PR_TITLE" =~ chistock-#([0-9]+) ]]; then
              ISSUE_NUMBER="${BASH_REMATCH[1]}"
              echo "Found issue number from PR title: $ISSUE_NUMBER"
            elif [[ "$PR_TITLE" =~ \#([0-9]+) ]]; then
              ISSUE_NUMBER="${BASH_REMATCH[1]}"
              echo "Found issue number from PR title (#): $ISSUE_NUMBER"
            fi
          fi
          
          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "âœ… Final issue number: $ISSUE_NUMBER"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "âŒ No issue number found"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi
      
      - name: Check if issue exists
        if: steps.extract_issue_reopen.outputs.issue_number != ''
        id: check_issue
        run: |
          ISSUE_NUMBER="${{ steps.extract_issue_reopen.outputs.issue_number }}"
          echo "Checking if issue #${ISSUE_NUMBER} exists..."
          
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ìŠˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}")
          
          issue_state=$(echo "$response" | jq -r '.state // "unknown"')
          
          if [[ "$issue_state" != "unknown" && "$issue_state" != "null" ]]; then
            echo "Issue #${ISSUE_NUMBER} exists with state: ${issue_state}"
            echo "issue_exists=true" >> $GITHUB_OUTPUT
            echo "current_state=${issue_state}" >> $GITHUB_OUTPUT
          else
            echo "Issue #${ISSUE_NUMBER} does not exist or cannot be accessed"
            echo "issue_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Ensure status labels exist
        if: steps.extract_issue_reopen.outputs.issue_number != '' && steps.check_issue.outputs.issue_exists == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            // í•„ìš”í•œ ë¼ë²¨ë“¤ì„ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ìƒì„±
            const labelsToCreate = [
              { name: 'IN PROGRESS', color: '0366d6', description: 'ì‘ì—… ì§„í–‰ ì¤‘ì¸ ì´ìŠˆ' },
              { name: 'DONE', color: '0e8a16', description: 'ì™„ë£Œëœ ì´ìŠˆ' }
            ];
            
            for (const label of labelsToCreate) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
                console.log(`Label '${label.name}' already exists`);
              } catch (error) {
                if (error.status === 404) {
                  console.log(`Creating label '${label.name}'`);
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                } else {
                  console.error(`Error checking label '${label.name}':`, error.message);
                }
              }
            }
      
      - name: Update issue status to IN PROGRESS
        if: steps.extract_issue_reopen.outputs.issue_number != '' && steps.check_issue.outputs.issue_exists == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const issueNumber = parseInt('${{ steps.extract_issue_reopen.outputs.issue_number }}');
            const prNumber = ${{ github.event.pull_request.number }};
            const prUrl = ${{ github.event.pull_request.html_url }};
            
            console.log(`PR #${prNumber} was reopened, updating linked issue #${issueNumber} to IN PROGRESS`);
            
            try {
              // 1. ë¨¼ì € ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              console.log(`Current issue state: ${issue.data.state}`);
              console.log(`Current issue labels: ${issue.data.labels.map(l => l.name).join(', ')}`);
              
              // 2. ì´ìŠˆê°€ closed ìƒíƒœë¼ë©´ openìœ¼ë¡œ ë³€ê²½
              if (issue.data.state === 'closed') {
                console.log('Issue is closed, reopening it...');
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'open'
                });
              }
              
              // 3. ê¸°ì¡´ ìƒíƒœ ë¼ë²¨ë“¤ ì œê±°
              const statusLabels = ['DONE', 'TODO', 'BACKLOG', 'IN REVIEW', 'READY FOR REVIEW'];
              
              for (const label of statusLabels) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    name: label
                  });
                  console.log(`Removed label: ${label}`);
                } catch (e) {
                  // ë¼ë²¨ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
                  if (e.status !== 404) {
                    console.log(`Label '${label}' not found or already removed`);
                  }
                }
              }
              
              // 4. IN PROGRESS ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['IN PROGRESS']
              });
              
              console.log('Added IN PROGRESS label');
              
              // 5. ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ”„ **ì´ìŠˆ ì¬ê°œë¨**\nì—°ê²°ëœ PR #${prNumber}ì´(ê°€) ì¬ì—´ë ¸ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ IN PROGRESS ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.\n\nPR ë§í¬: ${prUrl}`
              });
              
              console.log(`âœ… Successfully updated issue #${issueNumber} to IN PROGRESS`);
              
              // 6. PRì—ë„ ì„±ê³µ ì½”ë©˜íŠ¸ ì¶”ê°€ (ì„ íƒì‚¬í•­)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âœ… ì—°ê²°ëœ ì´ìŠˆ #${issueNumber}ì„(ë¥¼) IN PROGRESS ìƒíƒœë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`
              });
              
            } catch (error) {
              console.error(`âŒ Error updating issue #${issueNumber}:`, error);
              
              // ì—ëŸ¬ ë°œìƒì‹œ PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `âš ï¸ **ìë™ ì´ìŠˆ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨**\nì—°ê²°ëœ ì´ìŠˆ #${issueNumber}ë¥¼ IN PROGRESS ìƒíƒœë¡œ ë³€ê²½í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”.\n\nì—ëŸ¬: ${error.message}`
              });
            }
      
      - name: Log if no issue found
        if: steps.extract_issue_reopen.outputs.issue_number == '' || steps.check_issue.outputs.issue_exists != 'true'
        run: |
          echo "Skipping issue status update because:"
          echo "- Issue number extracted: ${{ steps.extract_issue_reopen.outputs.issue_number }}"
          echo "- Issue exists: ${{ steps.check_issue.outputs.issue_exists }}"
          
          if [[ "${{ steps.extract_issue_reopen.outputs.issue_number }}" == "" ]]; then
            echo "âš ï¸ No issue number could be extracted from PR."
            echo "PR should include 'Resolves #123' in the body or have 'chistock-#123' in branch name/title."
          fi
            
      # - name: Comment on issue
      #   uses: actions/github-script@v6
      #   with:
      #     script: |
      #       const issue = context.payload.issue;
      #       const branchName = '${{ steps.get_prefix.outputs.branch_name }}';
      #       const prNumber = ${{ steps.create_pr.outputs.result }};
            
      #       let prefixText = '';
      #       const prefix = '${{ steps.get_prefix.outputs.prefix }}';
      #       if (prefix) {
      #         prefixText = `**ì¹´í…Œê³ ë¦¬**: ${prefix.replace('/', '')}\n`;
      #       }
            
      #       await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: issue.number,
      #         body: `ğŸ‰ **ë¸Œëœì¹˜ ë° PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**\n\n` +
      #               `${prefixText}` +
      #               `**ì´ìŠˆ**: #${issue.number}\n` +
      #               `**ë¸Œëœì¹˜**: \`${branchName}\`\n` +
      #               `**PR**: #${prNumber}\n\n` +
      #               `í•´ë‹¹ ë¸Œëœì¹˜ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.`
      #       });
