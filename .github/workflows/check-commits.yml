name: 'Enforce Conventional Commit Template'

on:
 pull_request_target:
    types: [opened, edited, reopened, synchronize]
    branches: ['**']  # ëª¨ë“  ë¸Œëœì¹˜ì˜ PRì— ì ìš©
  push:
    branches: ['**']  # ëª¨ë“  ë¸Œëœì¹˜ì˜ í‘¸ì‹œì— ì ìš©

permissions:
  pull-requests: read
  contents: read

jobs:
  validate-commit-msg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°

      - name: Validate Commit Messages Against Template
        run: |
          # PR ê¸°ë°˜ ì‹¤í–‰ ì‹œ PRì˜ ì»¤ë°‹ë“¤ ê²€ì‚¬, ì§ì ‘ í‘¸ì‹œ ì‹œ í‘¸ì‹œëœ ì»¤ë°‹ ê²€ì‚¬
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            COMMITS=${{ github.event.pull_request.commits }}
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            echo "ğŸ“Œ PR ì´ë²¤íŠ¸: $COMMITSê°œì˜ ì»¤ë°‹ì„ ê²€ì‚¬í•©ë‹ˆë‹¤."
            COMMIT_LIST=$(git log --oneline $BASE_SHA..$HEAD_SHA | cut -d' ' -f1)
          else
            # Push ì´ë²¤íŠ¸: í‘¸ì‹œëœ ë²”ìœ„ì˜ ì»¤ë°‹ ê²€ì‚¬
            echo "ğŸ“Œ Push ì´ë²¤íŠ¸: í‘¸ì‹œëœ ì»¤ë°‹ì„ ê²€ì‚¬í•©ë‹ˆë‹¤."
            COMMIT_LIST=$(git log --oneline ${{ github.event.before }}..${{ github.event.after }} | cut -d' ' -f1)
          fi

          # ê²€ì‚¬ ë£¨í”„ ì‹œì‘
          for COMMIT_HASH in $COMMIT_LIST; do
            echo "----------------------------------------"
            echo "ğŸ” ì»¤ë°‹ ê²€ì‚¬ ì¤‘: $COMMIT_HASH"
            MSG=$(git log --format=%B -n 1 $COMMIT_HASH)
            
            # ê·œì¹™ 1: ì œëª© í˜•ì‹ ê²€ì‚¬ (íƒ€ì…: ì œëª©)
            if ! echo "$MSG" | head -1 | grep -qE '^(feat|fix|ci|docs|test|refact|style|chore)\s*:\s*.+'; then
              echo "âŒ [ì œëª© í˜•ì‹ ì˜¤ë¥˜] ì²« ì¤„ì€ 'íƒ€ì…: ì œëª©' í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: feat: ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€)"
              echo "   í—ˆìš© íƒ€ì…: feat, fix, ci, docs, test, refact, style, chore"
              echo "   ë°œê²¬ëœ ì œëª©: $(echo "$MSG" | head -1)"
              exit 1
            fi

            # ê·œì¹™ 2: ì œëª© ê¸¸ì´ ê²€ì‚¬ (50ì ì´ë‚´)
            TITLE=$(echo "$MSG" | head -1)
            TITLE_LENGTH=${#TITLE}
            if [ $TITLE_LENGTH -gt 50 ]; then
              echo "âŒ [ì œëª© ê¸¸ì´ ì˜¤ë¥˜] ì œëª©ì€ 50ì ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: $TITLE_LENGTHì)"
              echo "   ì œëª©: $TITLE"
              exit 1
            fi

            # ê·œì¹™ 3: ì œëª© ë ë§ˆì¹¨í‘œ ê¸ˆì§€
            if echo "$TITLE" | grep -q '\.$'; then
              echo "âŒ [ì œëª© ë§ˆì¹¨í‘œ ì˜¤ë¥˜] ì œëª© ëì— ë§ˆì¹¨í‘œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "   ì œëª©: $TITLE"
              exit 1
            fi

            # ê·œì¹™ 4: ì œëª©ê³¼ ë³¸ë¬¸ ì‚¬ì´ ë¹ˆ ì¤„ ê²€ì‚¬ (í…œí”Œë¦¿ì˜ 5ë²ˆì§¸ ì¤„ì´ ë¹„ì–´ ìˆì–´ì•¼ í•¨)
            if [ "$(echo "$MSG" | sed -n '5p')" != "" ]; then
              echo "âŒ [êµ¬ë¶„ì„  ì˜¤ë¥˜] ì œëª©ê³¼ ë³¸ë¬¸ì€ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (ì œëª© ì•„ë˜ 4ì¤„ì€ í…œí”Œë¦¿ ì„¤ëª…ì´ë¯€ë¡œ 5ë²ˆì§¸ ì¤„ì´ ë¹„ì–´ì•¼ í•¨)"
              exit 1
            fi

            # ê·œì¹™ 5: ë³¸ë¬¸ ê° ì¤„ ê¸¸ì´ ê²€ì‚¬ (72ì ì´ë‚´)
            BODY_START=6
            LINE_NUM=$BODY_START
            while IFS= read -r LINE; do
              if [ ${#LINE} -gt 72 ] && [ "$LINE" != "" ]; then
                echo "âŒ [ë³¸ë¬¸ ê¸¸ì´ ì˜¤ë¥˜] ë³¸ë¬¸ì˜ ê° ì¤„ì€ 72ì ì´ë‚´ì—¬ì•¼ í•©ë‹ˆë‹¤. ($LINE_NUMë²ˆì§¸ ì¤„, í˜„ì¬: ${#LINE}ì)"
                echo "   ë‚´ìš©: $LINE"
                exit 1
              fi
              ((LINE_NUM++))
            done <<< "$(echo "$MSG" | tail -n +$BODY_START)"

            # ê·œì¹™ 6: ë³¸ë¬¸ í˜•ì‹ ê²€ì‚¬ ('- 'ë¡œ ì‹œì‘í•˜ê±°ë‚˜ ê³µë°± ì¤„ì´ì–´ì•¼ í•¨, ê¼¬ë¦¬ë§ ì œì™¸)
            LINE_NUM=$BODY_START
            IN_FOOTER=false
            while IFS= read -r LINE; do
              # ê¼¬ë¦¬ë§ ì„¹ì…˜ ì‹œì‘ ê°ì§€
              if [[ "$LINE" =~ ^(fixes|resolves|ref|related to): ]]; then
                IN_FOOTER=true
                continue
              fi
              # ê¼¬ë¦¬ë§ ì„¹ì…˜ì´ ì•„ë‹Œ ë³¸ë¬¸ ì¤„ ê²€ì‚¬
              if [ "$IN_FOOTER" = false ] && [ "$LINE" != "" ]; then
                if ! [[ "$LINE" =~ ^- ]] && ! [[ "$LINE" =~ ^[[:space:]]*- ]]; then
                  echo "âŒ [ë³¸ë¬¸ í˜•ì‹ ì˜¤ë¥˜] ë³¸ë¬¸ ë‚´ìš©ì€ '- 'ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤. ($LINE_NUMë²ˆì§¸ ì¤„)"
                  echo "   ë°œê²¬: $LINE"
                  exit 1
                fi
              fi
              ((LINE_NUM++))
            done <<< "$(echo "$MSG" | tail -n +$BODY_START)"

            echo "âœ… ì»¤ë°‹ $COMMIT_HASH ê²€ì‚¬ í†µê³¼"
          done
          echo "========================================"
          echo "ğŸ‰ ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ê°€ í…œí”Œë¦¿ ê·œì¹™ì„ ì¤€ìˆ˜í•©ë‹ˆë‹¤."
